# EEG解析（前処理〜指標算出）の処理フロー（Method記述用）

## データ構成とセッション定義
- EEGはBrainVision形式の連続データとして取得し、同一被験者に複数の記録ファイルが存在する場合は時系列順に連結して1つの連続データとして扱った。
- 実験は少なくとも2つのセッションから構成され、各セッションの開始・終了は外部で記録されたトリガーログ（時刻付きの注釈列を含む）により定義した。
- 解析はセッション単位で実行し、各セッションについて前処理済みEEG（連続データ）とイベント系列を生成した。

## トリガー時刻のアラインメント（EEG時刻系への写像）
外部トリガーログの時刻（相対時間）をEEGデータの時刻系へ変換するため、EEG内の既存イベント列をアンカーとして用いた。

1. **外部トリガーログの前処理**
   - トリガーログから有効なトリガーのみを抽出し、ログ内の最初の有効トリガー時刻を基準として相対時間（秒）へ変換した。

2. **EEG側アンカーイベントの抽出**
   - EEGのアノテーションからアンカーとなるイベント（刺激マーカーの特定コード）を抽出し、その発生時刻（秒）列を得た。

3. **頑健な対応付け（オフセット／線形ドリフト）**
   - 外部トリガーログの相対時刻列（長さ$m$）を、EEGアンカーイベント時刻列（長さ$n$）の連続部分列にスライドさせ、最も整合する区間を探索した（$n\ge m$）。
   - 整合の評価には残差の中央値絶対偏差（MAD）を用い、外れ値に頑健な基準で最良区間を選択した。
   - 時刻変換は以下の2モデルを比較した。
     - **定数オフセットモデル**: $t_{EEG} \approx t_{log} + \Delta$
     - **線形ドリフトモデル**: $t_{EEG} \approx a + b\,t_{log}$
   - 線形ドリフトモデルがオフセットモデルより十分に改善する場合にのみ線形モデルを採用し、それ以外はオフセットモデルを採用した。

4. **セッション境界の推定と注釈の注入**
   - 外部トリガーログに含まれる「セッション開始」「セッション終了」に対応する注釈の時刻を、上記の写像によりEEG時刻系へ変換し、各セッションの境界時刻を得た。
   - さらに、外部トリガーログ中の各注釈イベントをEEG時刻系へ変換してEEGデータへ注釈として付加し、注釈からイベント配列を再生成した。

## セッション切り出しと時間基準の正規化
- 各セッションを独立に前処理するため、連続EEGからセッション区間を切り出した。
- **一次切り出し**として、セッション開始・終了の前後にバッファ（15秒）を付けて切り出し、境界付近のフィルタや分離処理の安定性を確保した。
- 前処理後、**二次切り出し**としてバッファを除去し、セッション開始〜終了の区間のみを最終解析対象とした。
- 保存データは、セッション開始を時刻0（サンプル0）とするよう時間基準を正規化し、注釈（イベント）のオンセットもセッション相対時刻に再配置した。これにより、保存された連続EEGとイベント系列が同一の基準で整合するようにした。

## EEG前処理
各セッション（一次切り出し後）に対して以下を実施した。

1. **リサンプリング**
   - サンプリング周波数を250 Hzへ変換した。
   - この際、イベントのサンプル座標もリサンプリングに合わせて変換した。

2. **帯域通過フィルタ**
   - EEGチャネルに対し1–40 Hzの帯域通過フィルタを適用した（ASRおよびICAの安定化を意図）。

3. **平均基準化**
   - EEGを平均参照（average reference）へ再参照した。

4. **ASR（Artifact Subspace Reconstruction）によるアーチファクト抑制**
   - EEGチャネルに対してASRを適用し、閾値（cutoff）を20としてアーチファクト成分の抑制を行った。

5. **ICAによる独立成分分離と自動ラベリング（利用可能な場合）**
   - EEGチャネルからICAを推定し、独立成分を得た。
   - 自動ラベリングが利用可能な環境では、眼球由来（瞬目）および筋電由来と推定された成分について、推定確率が0.90以上の場合に限り除外し、保守的な基準でICA補正を適用した。
   - 自動ラベリングが利用できない場合でもICA推定は行い、処理は破綻しないように設計した。

## 周波数領域の品質確認（PSD）
- 前処理済み連続EEGについて、Welch法によりパワースペクトル密度（PSD）を推定した。
- 周波数範囲は1–45 Hzとし、アノテーションで除外指定された区間は推定から除外した。
- 出力として、(i)全チャネル平均PSDカーブ、および(ii)指定周波数帯域内の平均PSDの頭皮トポグラフィを作成した。

## 心拍誘発電位（HEP）解析
HEPは、前処理済みEEGとR波ピーク列（ECG由来）を用いて算出した。

1. **R波イベント系列の構築**
   - R波ピークは別途抽出済みのピークインデックス列として与えられ、セッション区間に対応するピークのみが含まれることを前提とした。
   - ピークインデックスは500 Hz基準で保持されているため、EEGの250 Hzに合わせてサンプル変換（1/2）し、EEGのデータ長を超えるものは除外した。

2. **エポック化とアーチファクト除外**
   - R波を0秒として、$t=-0.3$〜$0.8$秒でエポック化した。
   - ベースライン補正は$-0.2$〜$-0.05$秒で実施した（0 msを含まない設定）。
   - 振幅閾値による除外は100 µV（EEG、ピークトゥピークではなく絶対振幅ベース）を用い、さらにアノテーションで除外指定された区間はエポック化時に除外した。

3. **平均波形（Evoked）の算出と可視化**
   - 残存エポックを平均し、HEP平均波形を算出した。
   - 可視化として、全チャネル波形（バタフライプロット）を出力した。
   - さらに、事前に定義した前頭・中心・頭頂を中心とするROI（例: Fz, Cz, Pz, C3, C4。存在しない場合は利用可能チャネルにフォールバック）を選択し、ROI内平均波形を算出・出力した。

## 生成物（解析アウトカム）
- セッションごとの前処理済み連続EEG（セッション開始を時刻0に正規化済み）。
- 外部トリガーログ由来の注釈に基づくイベント系列（サンプル座標）。
- 周波数領域の品質確認図（PSDカーブ、PSDトポグラフィ）。
- HEPの可視化図（全チャネル平均波形表示、ROI平均波形）。

## 解析上の注意（再現性・妥当性）
- 外部トリガーログとEEGの時刻整合は、頑健統計（MAD）に基づく探索と、必要時のみ線形ドリフト補正を許可することで、時計ずれ・欠損・外れ値に対する安定性を高めた。
- セッション境界の前後にバッファを設けてから前処理を行い、その後に境界で再切り出しする二段階処理により、境界近傍のフィルタ・分離処理の不安定化を抑制した。

# EEG解析（前処理）の処理フロー（Method記述用）

## データ構成とセッション定義
- EEGはBrainVision形式の連続データとして取得し、同一被験者に複数の記録ファイルが存在する場合は時系列順に連結して1つの連続データとして扱った。
- 実験は少なくとも2つのセッションから構成され、各セッションの開始・終了は外部で記録されたトリガーログ（時刻付きの注釈列を含む）により定義した。
- 解析はセッション単位で実行し、各セッションについて前処理済みEEG（連続データ）とイベント系列を生成した。

## トリガー時刻のアラインメント（EEG時刻系への写像）
外部トリガーログの時刻（相対時間）をEEGデータの時刻系へ変換するため、EEG内の既存イベント列をアンカーとして用いた。

1. **外部トリガーログの前処理**
   - トリガーログから有効なトリガーのみを抽出し、ログ内の最初の有効トリガー時刻を基準として相対時間（秒）へ変換した。

2. **EEG側アンカーイベントの抽出**
   - EEGのアノテーションからアンカーとなるイベント（刺激マーカーの特定コード）を抽出し、その発生時刻（秒）列を得た。

3. **頑健な対応付け（オフセット／線形ドリフト）**
   - 外部トリガーログの相対時刻列（長さ$m$）を、EEGアンカーイベント時刻列（長さ$n$）の連続部分列にスライドさせ、最も整合する区間を探索した（$n\ge m$）。
   - 整合の評価には残差の中央値絶対偏差（MAD）を用い、外れ値に頑健な基準で最良区間を選択した。
   - 時刻変換は以下の2モデルを比較した。
     - **定数オフセットモデル**: $t_{EEG} \approx t_{log} + \Delta$
     - **線形ドリフトモデル**: $t_{EEG} \approx a + b\,t_{log}$
   - 線形ドリフトモデルがオフセットモデルより十分に改善する場合にのみ線形モデルを採用し、それ以外はオフセットモデルを採用した。

4. **セッション境界の推定と注釈の注入**
   - 外部トリガーログに含まれる「セッション開始」「セッション終了」に対応する注釈の時刻を、上記の写像によりEEG時刻系へ変換し、各セッションの境界時刻を得た。
   - さらに、外部トリガーログ中の各注釈イベントをEEG時刻系へ変換してEEGデータへ注釈として付加し、注釈からイベント配列を再生成した。

## セッション切り出しと時間基準の正規化
- 各セッションを独立に前処理するため、連続EEGからセッション区間を切り出した。
- **一次切り出し**として、セッション開始・終了の前後にバッファ（15秒）を付けて切り出し、境界付近のフィルタや分離処理の安定性を確保した。
- 前処理後、**二次切り出し**としてバッファを除去し、セッション開始〜終了の区間のみを最終解析対象とした。
- 保存データは、セッション開始を時刻0（サンプル0）とするよう時間基準を正規化し、注釈（イベント）のオンセットもセッション相対時刻に再配置した。これにより、保存された連続EEGとイベント系列が同一の基準で整合するようにした。

## EEG前処理
各セッション（一次切り出し後）に対して以下を実施した。

1. **リサンプリング**
   - サンプリング周波数を250 Hzへ変換した。
   - この際、イベントのサンプル座標もリサンプリングに合わせて変換した。

2. **帯域通過フィルタ**
   - EEGチャネルに対し1–40 Hzの帯域通過フィルタを適用した（ASRおよびICAの安定化を意図）。

3. **平均基準化**
   - EEGを平均参照（average reference）へ再参照した。

4. **ASR（Artifact Subspace Reconstruction）によるアーチファクト抑制**
   - EEGチャネルに対してASRを適用し、閾値（cutoff）を20としてアーチファクト成分の抑制を行った。

5. **ICAによる独立成分分離と自動ラベリング（利用可能な場合）**
   - EEGチャネルからICAを推定し、独立成分を得た。
   - 自動ラベリングが利用可能な環境では、眼球由来（瞬目）および筋電由来と推定された成分について、推定確率が0.90以上の場合に限り除外し、保守的な基準でICA補正を適用した。
   - 自動ラベリングが利用できない場合でもICA推定は行い、処理は破綻しないように設計した。
